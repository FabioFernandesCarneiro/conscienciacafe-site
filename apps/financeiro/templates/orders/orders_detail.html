{% extends "base.html" %}

{% block title %}Pedido #{{ order.id }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="h4 mb-1"><i class="bi bi-receipt"></i> Pedido #{{ order.id }}</h2>
        <p class="text-muted mb-0">Detalhes completos do pedido e dos itens registrados.</p>
    </div>
    <div class="btn-group">
        <a class="btn btn-outline-secondary" href="{{ url_for('orders.orders_index') }}">
            <i class="bi bi-list"></i> Lista de pedidos
        </a>
        <a class="btn btn-primary" href="{{ url_for('orders.orders_edit', order_id=order.id) }}">
            <i class="bi bi-pencil"></i> Editar
        </a>
    </div>
</div>

<div class="row g-4">
    <div class="col-lg-5">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Resumo do pedido</h5>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-5 text-muted">Data</dt>
                    <dd class="col-sm-7">{{ order.order_date or '-' }}</dd>

                    <dt class="col-sm-5 text-muted">Cliente</dt>
                    <dd class="col-sm-7">
                        {% if order.lead_name %}
                            {{ order.lead_name }}
                        {% elif order.client_name %}
                            {{ order.client_name }}
                        {% else %}
                            <span class="text-muted">Não informado</span>
                        {% endif %}
                    </dd>

                    <dt class="col-sm-5 text-muted">Origem</dt>
                    <dd class="col-sm-7">{{ order.source or '-' }}</dd>

                    <dt class="col-sm-5 text-muted">Valor total</dt>
                    <dd class="col-sm-7">R$ {{ '%.2f'|format(order.total_amount or 0) }}</dd>
                </dl>
                {% if order.notes %}
                <hr>
                <div>
                    <span class="text-muted small text-uppercase">Observações</span>
                    <p class="mb-0 mt-2">{{ order.notes }}</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    <div class="col-lg-7">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Informações do cliente</h5>
            </div>
            <div class="card-body">
                {% if lead %}
                <dl class="row mb-0">
                    <dt class="col-sm-4 text-muted">Cidade</dt>
                    <dd class="col-sm-8">{{ lead.city or '-' }}{% if lead.state %} / {{ lead.state }}{% endif %}</dd>

                    <dt class="col-sm-4 text-muted">Contato</dt>
                    <dd class="col-sm-8">
                        {% if lead.phone %}
                            <div><i class="bi bi-telephone"></i> {{ lead.phone }}</div>
                        {% endif %}
                        {% if lead.whatsapp %}
                            <div><i class="bi bi-whatsapp"></i> {{ lead.whatsapp }}</div>
                        {% endif %}
                        {% if lead.email %}
                            <div><i class="bi bi-envelope"></i> {{ lead.email }}</div>
                        {% endif %}
                        {% if not (lead.phone or lead.whatsapp or lead.email) %}
                            <span class="text-muted">Não informado</span>
                        {% endif %}
                    </dd>

                    {% if lead.notes %}
                    <dt class="col-sm-4 text-muted">Notas do lead</dt>
                    <dd class="col-sm-8">{{ lead.notes }}</dd>
                    {% endif %}
                </dl>
                {% else %}
                <p class="text-muted mb-0">Não há informações adicionais do cliente.</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Itens do pedido</h5>
    </div>
    <div class="card-body">
        {% set order_items = order.get('items', []) %}
        {% if order_items %}
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead class="table-light">
                    <tr>
                        <th>Produto</th>
                        <th>Embalagem</th>
                        <th class="text-end">Quantidade</th>
                        <th class="text-end">Preço unit.</th>
                        <th class="text-end">Subtotal</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in order_items %}
                    <tr>
                        <td>{{ item.coffee_name or 'Produto não informado' }}</td>
                        <td>{{ item.package_size or '-' }}</td>
                        <td class="text-end">{{ '%.2f'|format(item.quantity or 0) }}</td>
                        <td class="text-end">R$ {{ '%.2f'|format(item.unit_price or 0) }}</td>
                        <td class="text-end">R$ {{ '%.2f'|format(item.line_total or (item.quantity or 0) * (item.unit_price or 0)) }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p class="text-muted mb-0">Nenhum item cadastrado para este pedido.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
