{% extends "base.html" %}

{% set is_edit = is_edit | default(false) %}
{% set form_order = order or {} %}
{% set page_title = 'Editar Pedido' if is_edit else 'Novo Pedido' %}
{% set current_lead_id = request.form.get('lead_id') if request.method == 'POST' else form_order.get('lead_id') %}
{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-xl-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-receipt"></i>
                    {{ 'Atualizar Pedido' if is_edit else 'Registrar Pedido' }}
                    {% if is_edit and form_order.get('id') %}
                    <span class="badge bg-secondary ms-2">#{{ form_order.get('id') }}</span>
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" id="formPedido" action="{{ url_for('orders.orders_edit', order_id=form_order.get('id')) if is_edit and form_order.get('id') else url_for('orders.orders_new') }}">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label" for="lead_search">Lead / Cliente</label>
                            <input type="text" class="form-control" id="lead_search" placeholder="Digite para buscar..." autocomplete="off">
                            <input type="hidden" id="lead_id" name="lead_id" value="{{ current_lead_id or '' }}">
                            <div id="lead_suggestions" class="position-absolute bg-white border rounded shadow-sm" style="display: none; max-height: 300px; overflow-y: auto; z-index: 1000; width: calc(100% - 30px);"></div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="order_date">Data</label>
                            <input type="date" class="form-control" id="order_date" name="order_date" value="{{ request.form.get('order_date') or form_order.get('order_date') or default_date }}">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label" for="currency">Moeda</label>
                            <input type="text" class="form-control" id="currency" name="currency" value="{{ request.form.get('currency') or form_order.get('currency') or 'BRL' }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="source">Origem / Campanha</label>
                            <input type="text" class="form-control" id="source" name="source" placeholder="Ex: Evento, Indicação" value="{{ request.form.get('source') or form_order.get('source') }}">
                        </div>
                        <div class="col-12">
                            <label class="form-label" for="notes">Observações</label>
                            <textarea class="form-control" id="notes" name="notes" rows="2">{{ request.form.get('notes') or form_order.get('notes') }}</textarea>
                        </div>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Itens do Pedido</h6>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="adicionarItem()">
                            <i class="bi bi-plus-circle"></i> Adicionar item
                        </button>
                    </div>

                    <div class="table-responsive">
                        <table class="table table-sm align-middle" id="tabelaItens">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 25%;">Café</th>
                                    <th style="width: 15%;">Embalagem</th>
                                    <th style="width: 15%;">Qtd</th>
                                    <th style="width: 15%;">Preço unit.</th>
                                    <th style="width: 20%;">Subtotal</th>
                                    <th style="width: 10%;"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>

                    <div class="d-flex justify-content-end mt-3">
                        <div class="text-end">
                            <div class="small text-muted">Total do pedido</div>
                            <div class="fw-semibold" id="totalPedido">R$ {{ '%.2f'|format(form_order.get('total_amount') or 0) }}</div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('orders.orders_view', order_id=form_order.get('id')) if is_edit and form_order.get('id') else url_for('orders.orders_index') }}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg"></i> {{ 'Atualizar Pedido' if is_edit else 'Salvar Pedido' }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const COFFEES = {{ coffees | tojson }};
    const PACKAGE_SIZES = {{ package_sizes | tojson }};
    const EXISTING_ITEMS = {{ (form_order.get('items') or []) | tojson }};
    const LEADS = {{ leads | tojson }};

    function optionCafes(selectedId = '') {
        return ['<option value="">(Padrão)</option>'].concat(
            COFFEES.map(coffee => `<option value="${coffee.id}" ${String(coffee.id) === String(selectedId || '') ? 'selected' : ''}>${coffee.name}</option>`)
        ).join('');
    }

    function optionPackages(selected = '') {
        return ['<option value="">--</option>'].concat(
            PACKAGE_SIZES.map(size => `<option value="${size}" ${size === selected ? 'selected' : ''}>${size}</option>`)
        ).join('');
    }

    function adicionarItem(item = {}) {
        const tbody = document.querySelector('#tabelaItens tbody');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>
                <select class="form-select" name="item_coffee_id">
                    ${optionCafes(item.coffee_id)}
                </select>
            </td>
            <td>
                <select class="form-select" name="item_package_size">
                    ${optionPackages(item.package_size || PACKAGE_SIZES[PACKAGE_SIZES.length - 1] || '')}
                </select>
            </td>
            <td>
                <input type="number" step="0.01" min="0" class="form-control" name="item_quantity" value="${item.quantity ?? ''}" required>
            </td>
            <td>
                <input type="number" step="0.01" min="0" class="form-control" name="item_unit_price" value="${item.unit_price ?? ''}" required>
            </td>
            <td>
                <input type="text" class="form-control-plaintext text-end subtotal" value="0.00" readonly>
            </td>
            <td class="text-end">
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removerItem(this)">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
        anexarEventosLinha(row, item);
    }

    function removerItem(button) {
        const row = button.closest('tr');
        if (row) {
            row.remove();
            atualizarTotais();
        }
    }

    function obterPrecoSugerido(coffeeId, packageSize) {
        if (!coffeeId || !packageSize) {
            return '';
        }
        const coffee = COFFEES.find(c => String(c.id) === String(coffeeId));
        if (!coffee || !coffee.prices_map) {
            return '';
        }
        const price = coffee.prices_map[packageSize];
        return price !== undefined ? price : '';
    }

    function anexarEventosLinha(row, item = {}) {
        const coffeeSelect = row.querySelector('select[name="item_coffee_id"]');
        const packageSelect = row.querySelector('select[name="item_package_size"]');
        const priceInput = row.querySelector('input[name="item_unit_price"]');
        const quantityInput = row.querySelector('input[name="item_quantity"]');
        const subtotalField = row.querySelector('.subtotal');

        function atualizarPreco() {
            const price = obterPrecoSugerido(coffeeSelect.value, packageSelect.value);
            if (price !== '') {
                priceInput.value = price;
            }
            atualizarSubtotal();
        }

        function atualizarSubtotal() {
            const quantidade = parseFloat((quantityInput.value || '').replace(',', '.')) || 0;
            const preco = parseFloat((priceInput.value || '').replace(',', '.')) || 0;
            const subtotal = quantidade * preco;
            subtotalField.value = subtotal.toFixed(2);
            atualizarTotais();
        }

        coffeeSelect.addEventListener('change', atualizarPreco);
        packageSelect.addEventListener('change', atualizarPreco);
        quantityInput.addEventListener('input', atualizarSubtotal);
        priceInput.addEventListener('input', atualizarSubtotal);

        if (item.unit_price === undefined || item.unit_price === null || item.unit_price === '') {
            atualizarPreco();
        } else {
            atualizarSubtotal();
        }
    }

    function atualizarTotais() {
        const subtotais = document.querySelectorAll('#tabelaItens .subtotal');
        let total = 0;
        subtotais.forEach(input => {
            const valor = parseFloat((input.value || '').replace(',', '.')) || 0;
            total += valor;
        });
        document.getElementById('totalPedido').textContent = `R$ ${total.toFixed(2)}`;
    }

    // Lead autocomplete
    const leadSearchInput = document.getElementById('lead_search');
    const leadIdInput = document.getElementById('lead_id');
    const suggestionsDiv = document.getElementById('lead_suggestions');

    function filterLeads(query) {
        if (!query) return LEADS;
        const q = query.toLowerCase();
        return LEADS.filter(lead =>
            lead.name.toLowerCase().includes(q) ||
            (lead.city && lead.city.toLowerCase().includes(q)) ||
            (lead.country && lead.country.toLowerCase().includes(q))
        );
    }

    function showSuggestions(leads) {
        if (leads.length === 0) {
            suggestionsDiv.style.display = 'none';
            return;
        }

        const html = leads.slice(0, 50).map(lead => {
            const displayText = lead.name +
                (lead.city ? ` - ${lead.city}` : '') +
                (lead.country ? `, ${lead.country}` : '');
            return `<div class="p-2 cursor-pointer lead-suggestion" data-id="${lead.id}" data-name="${lead.name}" style="cursor: pointer; border-bottom: 1px solid #eee;">
                        <i class="bi bi-person-circle me-2"></i>${displayText}
                    </div>`;
        }).join('');

        suggestionsDiv.innerHTML = html;
        suggestionsDiv.style.display = 'block';

        // Add click handlers
        document.querySelectorAll('.lead-suggestion').forEach(item => {
            item.addEventListener('click', function() {
                leadIdInput.value = this.dataset.id;
                leadSearchInput.value = this.dataset.name;
                suggestionsDiv.style.display = 'none';
            });

            item.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#f8f9fa';
            });

            item.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'white';
            });
        });
    }

    leadSearchInput.addEventListener('input', function() {
        const query = this.value.trim();
        const filtered = filterLeads(query);
        showSuggestions(filtered);
    });

    leadSearchInput.addEventListener('focus', function() {
        const query = this.value.trim();
        const filtered = filterLeads(query);
        showSuggestions(filtered);
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== leadSearchInput && e.target !== suggestionsDiv && !suggestionsDiv.contains(e.target)) {
            suggestionsDiv.style.display = 'none';
        }
    });

    // Set initial value if lead_id exists
    if (leadIdInput.value) {
        const lead = LEADS.find(l => String(l.id) === String(leadIdInput.value));
        if (lead) {
            leadSearchInput.value = lead.name;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        if (EXISTING_ITEMS.length) {
            EXISTING_ITEMS.forEach(item => adicionarItem(item));
        } else {
            adicionarItem();
        }
        atualizarTotais();
    });
</script>
{% endblock %}
