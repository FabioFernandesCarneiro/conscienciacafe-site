{% extends "base.html" %}

{% set stage_options = stage_options or [] %}
{% set users = users or [] %}

{% block title %}CRM B2B - Consci√™ncia Caf√©{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <div>
        <h1 class="h2"><i class="bi bi-people"></i> CRM B2B</h1>
        <p class="text-muted mb-0">Prospec√ß√£o e acompanhamento de leads</p>
    </div>
    <div class="btn-group">
        <button class="btn btn-primary" onclick="novoLead()">
            <i class="bi bi-plus-lg"></i> Novo Lead
        </button>
        <button class="btn btn-outline-secondary" onclick="carregarLeads()">
            <i class="bi bi-arrow-clockwise"></i>
        </button>
    </div>
</div>

<div class="card mb-4">
    <div class="card-header">
        <h5 class="card-title mb-0"><i class="bi bi-compass"></i> Descobrir Leads (Google Maps)</h5>
    </div>
    <div class="card-body">
        <form id="formBuscaMaps" class="row g-3">
            <div class="col-md-4">
                <label class="form-label">Termo de busca</label>
                <input type="text" class="form-control" name="keyword" placeholder="cafeteria, consult√≥rio m√©dico..." required>
            </div>
            <div class="col-md-3">
                <label class="form-label">Cidade</label>
                <input type="text" class="form-control" name="city" placeholder="S√£o Paulo" required>
            </div>
            <div class="col-md-2">
                <label class="form-label">Estado</label>
                <input type="text" class="form-control" name="state" placeholder="SP">
            </div>
            <div class="col-md-2">
                <label class="form-label">Pa√≠s</label>
                <select class="form-select" name="country">
                    <option value="Brasil" selected>Brasil</option>
                    <option value="Argentina">Argentina</option>
                    <option value="Paraguai">Paraguai</option>
                </select>
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-outline-primary w-100">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </div>
            <div class="col-12">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" name="enrich" id="enrichCheck">
                    <label class="form-check-label" for="enrichCheck">
                        üîç Enriquecer resultados (buscar Instagram/WhatsApp nos websites - mais lento)
                    </label>
                </div>
            </div>
        </form>
        <small class="text-muted">A busca utiliza Google Places; o consumo depende da chave `GOOGLE_API_KEY` configurada no .env.</small>

        <div id="mapsResultados" class="mt-4" style="display: none;">
            <h6 class="mb-3">Resultados da busca (<span id="mapsTotal"></span>)</h6>
            <div class="table-responsive">
                <table class="table table-sm table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Nome</th>
                            <th>Endere√ßo</th>
                            <th>Contato</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="mapsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Formul√°rio de cria√ß√£o inline removido; cria√ß√£o acontecer√° via modal compartilhado -->

<div class="card">
    <div class="card-body">
        <div class="row g-3 mb-3">
            <div class="col-md-3">
                <label class="form-label">Buscar</label>
                <input type="text" id="filtroBusca" class="form-control" placeholder="Nome ou cidade">
            </div>
            <div class="col-md-3">
                <label class="form-label">Status</label>
                <select id="filtroStatus" class="form-select">
                    <option value="">Todos</option>
                    {% for stage in stage_options %}
                    <option value="{{ stage.value }}">{{ stage.label }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Cidade</label>
                <input type="text" id="filtroCidade" class="form-control">
            </div>
            <div class="col-md-2">
                <label class="form-label">Pa√≠s</label>
                <select id="filtroPais" class="form-select">
                    <option value="">Todos</option>
                    <option value="Brasil">Brasil</option>
                    <option value="Argentina">Argentina</option>
                    <option value="Paraguai">Paraguai</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-outline-primary me-2" onclick="carregarLeads()">
                    <i class="bi bi-search"></i> Filtrar
                </button>
                <button class="btn btn-outline-secondary" onclick="limparFiltros()">
                    <i class="bi bi-x-circle"></i> Limpar
                </button>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="tabelaLeads">
                <thead class="table-light">
                    <tr>
                        <th>Nome</th>
                        <th>Localiza√ß√£o</th>
                        <th>Contato</th>
                        <th>Status</th>
                        <th>Respons√°vel</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    const STAGE_OPTIONS = {{ stage_options | tojson }};
    const STAGE_LOOKUP = Object.fromEntries((STAGE_OPTIONS || []).map(stage => [stage.value, stage]));
    const DEFAULT_STAGE = (STAGE_OPTIONS && STAGE_OPTIONS.length) ? STAGE_OPTIONS[0].value : 'nao_contactado';
    const COUNTRY_OPTIONS = ['Brasil', 'Argentina', 'Paraguai'];
    const USERS = {{ users | tojson }};
    const CURRENT_USER_ID = {{ current_user.id if current_user.is_authenticated else 'null' }};
    const CURRENT_USER_IS_ADMIN = {{ 'true' if current_user.is_authenticated and current_user.is_admin else 'false' }};
    const FIELD_LABELS = {
        name: 'Nome',
        category: 'Categoria',
        customer_type: 'Tipo de Cliente',
        city: 'Cidade',
        state: 'Estado',
        country: 'Pa√≠s',
        phone: 'Telefone',
        whatsapp: 'WhatsApp',
        email: 'E-mail',
        instagram: 'Instagram',
        website: 'Website',
        notes: 'Observa√ß√µes',
        owner: 'Respons√°vel',
        primary_contact_name: 'Contato principal',
        source: 'Origem',
        address_line: 'Endere√ßo',
        address_number: 'N√∫mero',
        address_complement: 'Complemento',
        neighborhood: 'Bairro',
        postal_code: 'CEP',
        latitude: 'Latitude',
        longitude: 'Longitude',
    };
    const EVENT_STYLES = {
        comment: 'success',
        status_change: 'primary',
        update: 'warning',
        create: 'secondary',
    };

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('formBuscaMaps').addEventListener('submit', buscarMaps);
        carregarLeads();
    });

    function buildStageOptions(selected = DEFAULT_STAGE) {
        return (STAGE_OPTIONS || []).map(stage => `
            <option value="${stage.value}" ${stage.value === selected ? 'selected' : ''}>${stage.label}</option>
        `).join('');
    }

    function renderStageSelect({ selected = DEFAULT_STAGE, name = 'status', classes = 'form-select' } = {}) {
        return `<select class="${classes}" name="${name}">${buildStageOptions(selected)}</select>`;
    }

    function buildCountryOptions(selected = '', includeEmpty = false) {
        const normalized = selected || '';
        const options = [];
        if (includeEmpty) {
            options.push(`<option value="">Selecione</option>`);
        }
        COUNTRY_OPTIONS.forEach(country => {
            options.push(`<option value="${country}" ${country === normalized ? 'selected' : ''}>${country}</option>`);
        });
        return options.join('');
    }

    function buildUserOptions(selectedId = null) {
        const selected = selectedId || CURRENT_USER_ID;
        return (USERS || []).map(user => {
            const suffix = user.role === 'vendedor' ? ` (Vendedor${user.country ? ' - ' + user.country : ''})` : '';
            const isSelected = String(user.id) === String(selected) ? 'selected' : '';
            return `<option value="${user.id}" ${isSelected}>${user.username}${suffix}</option>`;
        }).join('');
    }

    function renderUserField(selectedId = null) {
        if (CURRENT_USER_IS_ADMIN) {
            return `
                <div class="col-md-6">
                    <label class="form-label">Responsavel</label>
                    <select class="form-select" name="user_id">
                        ${buildUserOptions(selectedId)}
                    </select>
                </div>
            `;
        } else {
            return `<input type="hidden" name="user_id" value="${CURRENT_USER_ID || ''}">`;
        }
    }

    function atualizarBadge(selectElement, stageValue) {
        const stageInfo = STAGE_LOOKUP[stageValue] || {};
        const badge = selectElement.closest('td')?.querySelector('[data-role="stage-badge"]');
        if (!badge) return;
        badge.textContent = stageInfo.label || stageValue || '-';
        badge.className = `badge bg-${stageInfo.badge || 'secondary'}`;
    }

    function ativarDropdownStatus() {
        document.querySelectorAll('.lead-stage-select').forEach(select => {
            select.dataset.previousValue = select.value;
            atualizarBadge(select, select.value);
            select.addEventListener('change', async event => {
                const target = event.target;
                const leadId = target.dataset.leadId;
                const novoStatus = target.value;
                try {
                    await atualizarStatusLead(leadId, novoStatus);
                    target.dataset.previousValue = novoStatus;
                    atualizarBadge(target, novoStatus);
                    mostrarToast('Status atualizado com sucesso!', 'success');
                } catch (error) {
                    mostrarToast(`Erro: ${error.message}`, 'danger');
                    target.value = target.dataset.previousValue || DEFAULT_STAGE;
                    atualizarBadge(target, target.value);
                }
            });
        });
    }

    async function buscarMaps(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        // Converter checkbox para boolean string
        const params = new URLSearchParams();
        for (const [key, value] of formData.entries()) {
            if (key === 'enrich') {
                params.append(key, 'true');
            } else {
                params.append(key, value);
            }
        }

        const enrichEnabled = formData.has('enrich');
        if (enrichEnabled) {
            mostrarToast('üîç Enriquecendo resultados... Isso pode demorar alguns segundos.', 'info');
        }

        try {
            const response = await fetch(`/crm/api/leads/discover?${params.toString()}`);
            const data = await response.json();
            if (!data.success) throw new Error(data.error || 'Erro na busca');
            renderizarResultadosMaps(data.results || []);
            if (enrichEnabled) {
                mostrarToast('‚úÖ Resultados enriquecidos!', 'success');
            }
        } catch (error) {
            mostrarToast(`Erro: ${error.message}`, 'danger');
        }
    }

    function renderizarResultadosMaps(resultados) {
        const wrapper = document.getElementById('mapsResultados');
        const tableBody = document.getElementById('mapsTableBody');
        const total = document.getElementById('mapsTotal');
        tableBody.innerHTML = '';

        if (!Array.isArray(resultados) || resultados.length === 0) {
            wrapper.style.display = 'block';
            total.textContent = '0';
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">Nenhum resultado encontrado</td></tr>';
            return;
        }

        total.textContent = resultados.length;
        resultados.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <strong>${item.name}</strong><br>
                    <small class="text-muted">${item.category || 'N/A'}</small>
                </td>
                <td>
                    ${item.address || '-'}
                    ${item.city || item.state ? `<div class="text-muted small">${[item.city, item.state].filter(Boolean).join(' / ')}</div>` : ''}
                    ${item.country ? `<div class="text-muted small">${item.country}</div>` : ''}
                </td>
                <td>
                    ${item.phone ? `<div><i class="bi bi-telephone"></i> ${item.phone}</div>` : ''}
                    ${item.whatsapp ? `<div><i class="bi bi-whatsapp text-success"></i> <a href="https://wa.me/${item.whatsapp.replace(/\D/g, '')}" target="_blank" class="text-success">${item.whatsapp}</a></div>` : ''}
                    ${item.instagram ? `<div><i class="bi bi-instagram text-danger"></i> <a href="https://instagram.com/${item.instagram.replace('@', '')}" target="_blank" class="text-danger">@${item.instagram.replace('@', '')}</a></div>` : ''}
                    ${item.website ? `<div><i class="bi bi-globe"></i> <a href="${item.website}" target="_blank">Site</a></div>` : ''}
                    ${!item.phone && !item.whatsapp && !item.instagram && !item.website ? '<small class="text-muted">Sem contato</small>' : ''}
                </td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-primary" data-action="import">
                        Adicionar
                    </button>
                </td>
            `;
            const importBtn = row.querySelector('[data-action="import"]');
            importBtn.addEventListener('click', () => importarLead(item));
            tableBody.appendChild(row);
        });

        wrapper.style.display = 'block';
    }

    async function importarLead(data) {
        try {
            const response = await fetch('/crm/api/leads', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    name: data.name,
                    category: data.category,
                    city: data.city,
                    state: data.state,
                    address_line: data.address_line || data.address,
                    address_number: data.address_number,
                    neighborhood: data.neighborhood,
                    postal_code: data.postal_code,
                    country: data.country,
                    latitude: data.latitude,
                    longitude: data.longitude,
                    phone: data.phone,
                    whatsapp: data.whatsapp,
                    instagram: data.instagram,
                    website: data.website,
                    source: data.source,
                    google_place_id: data.place_id,
                    search_keyword: data.search_keyword,
                    search_city: data.search_city
                })
            });

            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Erro ao importar lead');
            mostrarToast('Lead importado com sucesso!', 'success');
            carregarLeads();
        } catch (error) {
            mostrarToast(`Erro: ${error.message}`, 'danger');
        }
    }

    async function carregarLeads(page = 1) {
        try {
            const params = new URLSearchParams({
                search: document.getElementById('filtroBusca').value.trim(),
                status: document.getElementById('filtroStatus').value,
                city: document.getElementById('filtroCidade').value.trim(),
                country: document.getElementById('filtroPais').value
            });

            const response = await fetch(`/crm/api/leads?${params.toString()}`);
            const data = await response.json();

            if (!data.success) {
                throw new Error(data.error || 'Erro ao carregar leads');
            }

            renderizarLeads(data.leads || []);
            ativarDropdownStatus();
        } catch (error) {
            mostrarToast(`Erro: ${error.message}`, 'danger');
        }
    }

    async function atualizarStatusLead(leadId, novoStatus) {
        const response = await fetch(`/crm/api/leads/${leadId}`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ status: novoStatus })
        });

        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Erro ao atualizar status');
        }
    }

    // Removido: salvarLead() do formul√°rio de cria√ß√£o antigo. Cria√ß√£o usa salvarLeadModal(null).

    function renderizarLeads(leads) {
        const tbody = document.querySelector('#tabelaLeads tbody');
        tbody.innerHTML = '';

        if (!Array.isArray(leads) || leads.length === 0) {
            const row = document.createElement('tr');
            row.innerHTML = '<td colspan="6" class="text-center text-muted py-4">Nenhum lead encontrado</td>';
            tbody.appendChild(row);
            return;
        }

        leads.forEach(lead => {
            const leadName = lead.name || '';
            const safeLeadName = escapeHtml(leadName);
            const row = document.createElement('tr');
            const stageValue = lead.status || DEFAULT_STAGE;
            const stageInfo = STAGE_LOOKUP[stageValue] || {};
            const badgeClass = `badge bg-${stageInfo.badge || 'secondary'}`;
            const stageLabel = lead.status_label || stageInfo.label || stageValue;
            const locationLine = [lead.city, lead.state].filter(Boolean).join(' / ');

            const customerTypeBadge = lead.customer_type === 'B2C'
                ? '<span class="badge bg-info ms-2">B2C</span>'
                : '<span class="badge bg-secondary ms-2">B2B</span>';

            row.innerHTML = `
                <td>
                    <strong>${safeLeadName || '-'}</strong>${customerTypeBadge}<br>
                    <small class="text-muted">Origem: ${escapeHtml(lead.source || 'N/A')}</small>
                </td>
                <td>
                    ${escapeHtml(locationLine || '-')}
                    ${lead.country ? `<div class="text-muted small">${escapeHtml(lead.country)}</div>` : ''}
                </td>
                <td>
                    ${lead.phone ? `<div><i class="bi bi-telephone"></i> ${escapeHtml(lead.phone)}</div>` : ''}
                    ${lead.whatsapp ? `<div><i class="bi bi-whatsapp text-success"></i> <a href="https://wa.me/${lead.whatsapp.replace(/\D/g, '')}" target="_blank">${escapeHtml(lead.whatsapp)}</a></div>` : ''}
                    ${lead.instagram ? `<div><i class="bi bi-instagram text-danger"></i> <a href="https://instagram.com/${lead.instagram.replace('@', '')}" target="_blank">@${escapeHtml(lead.instagram.replace('@', ''))}</a></div>` : ''}
                    ${lead.email ? `<div><i class="bi bi-envelope"></i> ${escapeHtml(lead.email)}</div>` : ''}
                    ${!lead.phone && !lead.whatsapp && !lead.instagram && !lead.email ? '<small class="text-muted">-</small>' : ''}
                </td>
                <td>
                    <div class="d-flex flex-column gap-2">
                        <span class="${badgeClass}" data-role="stage-badge">${stageLabel}</span>
                        <select class="form-select form-select-sm lead-stage-select" data-lead-id="${lead.id}">
                            ${buildStageOptions(stageValue)}
                        </select>
                    </div>
                </td>
                <td>${escapeHtml(lead.user_name || lead.owner || '-')}</td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-info" onclick="editarLead(${lead.id})" title="Editar lead">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" data-action="timeline" title="Intera√ß√µes">
                        <i class="bi bi-chat"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" data-action="delete" title="Excluir lead">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            `;
            tbody.appendChild(row);

            const timelineBtn = row.querySelector('[data-action="timeline"]');
            if (timelineBtn) {
                timelineBtn.addEventListener('click', () => abrirInteracoes(lead.id, leadName));
            }
            const deleteBtn = row.querySelector('[data-action="delete"]');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', () => solicitarExclusaoLead(lead.id, leadName));
            }
        });
    }

    function limparFiltros() {
        document.getElementById('filtroBusca').value = '';
        document.getElementById('filtroStatus').value = '';
        document.getElementById('filtroCidade').value = '';
        document.getElementById('filtroPais').value = '';
        carregarLeads();
    }

    async function abrirInteracoes(leadId, leadName = '') {
        const modalEl = ensureTimelineModal();
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        const titleNameEl = modalEl.querySelector('[data-role="lead-name"]');
        const titleIdEl = modalEl.querySelector('[data-role="lead-id"]');
        const timelineList = modalEl.querySelector('[data-role="timeline-list"]');
        const commentForm = modalEl.querySelector('#formComentarioLead');

        titleNameEl.textContent = leadName || 'Lead sem nome';
        titleIdEl.textContent = `#${leadId}`;
        modalEl.dataset.leadId = leadId;
        commentForm.dataset.leadId = leadId;
        commentForm.dataset.leadName = leadName || '';

        timelineList.innerHTML = '<li class="text-muted">Carregando hist√≥rico...</li>';
        modal.show();

        try {
            const response = await fetch(`/crm/api/leads/${leadId}/interactions`);
            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'Erro ao carregar hist√≥rico');
            }
            renderTimelineItems(timelineList, data.interactions || []);
        } catch (error) {
            timelineList.innerHTML = `<li class="text-danger">${escapeHtml(error.message)}</li>`;
        }
    }

    function ensureTimelineModal() {
        let modalEl = document.getElementById('modalTimelineLead');
        if (modalEl) {
            return modalEl;
        }

        const modalHtml = `
            <div class="modal fade" id="modalTimelineLead" tabindex="-1">
                <div class="modal-dialog modal-lg modal-dialog-scrollable">
                    <div class="modal-content" style="height: 85vh;">
                        <div class="modal-header border-bottom">
                            <div>
                                <h5 class="modal-title">Hist√≥rico do Lead <span data-role="lead-name"></span></h5>
                                <small class="text-muted" data-role="lead-id"></small>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body p-0" style="flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                            <div class="p-3 pb-4" style="flex: 1; overflow-y: auto;">
                                <ul class="list-unstyled timeline-list mb-0" data-role="timeline-list">
                                    <li class="text-muted">Carregando hist√≥rico...</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer border-top bg-light p-3" style="flex-shrink: 0;">
                            <form id="formComentarioLead" class="w-100">
                                <div class="input-group">
                                    <textarea class="form-control" name="notes" rows="2" placeholder="Adicione um coment√°rio..." required style="resize: none;"></textarea>
                                    <button type="submit" class="btn btn-primary px-4">
                                        <i class="bi bi-send"></i>
                                    </button>
                                </div>
                                <small class="text-muted d-block mt-1">
                                    <i class="bi bi-person-circle"></i> Coment√°rio ser√° registrado em seu nome
                                </small>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modalEl = document.getElementById('modalTimelineLead');
        const commentForm = modalEl.querySelector('#formComentarioLead');
        commentForm.addEventListener('submit', enviarComentarioLead);
        modalEl.addEventListener('shown.bs.modal', () => {
            const textarea = commentForm.querySelector('textarea[name="notes"]');
            textarea.focus();
            // Auto-scroll para o final da timeline
            const timelineContainer = modalEl.querySelector('.modal-body > div');
            if (timelineContainer) {
                setTimeout(() => timelineContainer.scrollTop = timelineContainer.scrollHeight, 100);
            }
        });
        return modalEl;
    }

    async function excluirLead(leadId) {
        const response = await fetch(`/crm/api/leads/${leadId}`, {
            method: 'DELETE'
        });
        const result = await response.json();
        if (!result.success) {
            throw new Error(result.error || 'Erro ao excluir lead');
        }
    }

    function solicitarExclusaoLead(leadId, leadName = '') {
        const modalEl = ensureDeleteModal();
        modalEl.dataset.leadId = leadId;
        modalEl.dataset.leadName = leadName;
        modalEl.querySelector('[data-role="lead-name"]').textContent = leadName || 'Lead sem nome';
        modalEl.querySelector('[data-role="lead-id"]').textContent = `ID interno: #${leadId}`;
        const confirmBtn = modalEl.querySelector('[data-role="confirm-delete"]');
        confirmBtn.disabled = false;
        confirmBtn.innerHTML = '<i class="bi bi-trash"></i> Excluir';
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
    }

    function ensureDeleteModal() {
        let modalEl = document.getElementById('modalExcluirLead');
        if (modalEl) {
            return modalEl;
        }

        const modalHtml = `
            <div class="modal fade" id="modalExcluirLead" tabindex="-1" aria-labelledby="modalExcluirLeadLabel">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title" id="modalExcluirLeadLabel">
                                <i class="bi bi-exclamation-triangle"></i> Confirmar exclus√£o
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <p>Tem certeza de que deseja excluir o lead <strong data-role="lead-name"></strong>?</p>
                            <p class="text-muted small mb-0">Todas as intera√ß√µes relacionadas ser√£o removidas definitivamente.</p>
                            <div class="text-muted small" data-role="lead-id"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger" data-role="confirm-delete">
                                <i class="bi bi-trash"></i> Excluir
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        document.body.insertAdjacentHTML('beforeend', modalHtml);
        modalEl = document.getElementById('modalExcluirLead');
        const confirmBtn = modalEl.querySelector('[data-role="confirm-delete"]');

        confirmBtn.addEventListener('click', async () => {
            const modalInstance = bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
            const leadId = Number(modalEl.dataset.leadId || 0);
            if (!leadId) {
                mostrarToast('ID do lead inv√°lido.', 'danger');
                return;
            }
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Excluindo...';
            try {
                await excluirLead(leadId);
                modalInstance.hide();
                mostrarToast('Lead exclu√≠do com sucesso!', 'success');
                carregarLeads();
            } catch (error) {
                mostrarToast(`Erro: ${error.message}`, 'danger');
            } finally {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="bi bi-trash"></i> Excluir';
            }
        });

        modalEl.addEventListener('hidden.bs.modal', () => {
            const confirmButton = modalEl.querySelector('[data-role="confirm-delete"]');
            confirmButton.disabled = false;
            confirmButton.innerHTML = '<i class="bi bi-trash"></i> Excluir';
        });

        return modalEl;
    }

    async function enviarComentarioLead(event) {
        event.preventDefault();
        const form = event.target;
        const leadId = form.dataset.leadId;
        if (!leadId) {
            mostrarToast('Lead n√£o encontrado para registrar o coment√°rio.', 'danger');
            return;
        }

        const notes = form.elements['notes'].value.trim();
        if (!notes) {
            mostrarToast('Digite um coment√°rio antes de enviar.', 'warning');
            form.elements['notes'].focus();
            return;
        }

        const submitButton = form.querySelector('button[type="submit"]');
        const originalButtonHtml = submitButton.innerHTML;
        submitButton.disabled = true;
        submitButton.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

        try {
            const response = await fetch(`/crm/api/leads/${leadId}/interactions`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ notes })
            });

            const data = await response.json();
            if (!data.success) {
                throw new Error(data.error || 'Erro ao adicionar coment√°rio');
            }

            form.reset();
            form.elements['notes'].focus();

            const timelineList = document.querySelector('#modalTimelineLead [data-role="timeline-list"]');
            renderTimelineItems(timelineList, data.interactions || []);

            // Auto-scroll para o final da timeline para ver o novo coment√°rio
            const timelineContainer = document.querySelector('#modalTimelineLead .modal-body > div');
            if (timelineContainer) {
                setTimeout(() => timelineContainer.scrollTop = timelineContainer.scrollHeight, 100);
            }

            mostrarToast('Coment√°rio registrado com sucesso!', 'success');
        } catch (error) {
            mostrarToast(`Erro: ${error.message}`, 'danger');
        } finally {
            submitButton.disabled = false;
            submitButton.innerHTML = originalButtonHtml;
        }
    }

    function renderTimelineItems(container, interactions) {
        if (!Array.isArray(interactions) || interactions.length === 0) {
            container.innerHTML = '<li class="text-muted">Sem eventos registrados ainda.</li>';
            return;
        }

        const itemsHtml = interactions.map(evento => {
            const tipo = evento.interaction_type || 'comment';
            const badgeClass = EVENT_STYLES[tipo] || 'secondary';
            const dataHora = formatDateTime(evento.interaction_at);
            const owner = evento.owner ? ` ‚Ä¢ ${escapeHtml(evento.owner)}` : '';
            const header = `<div class="d-flex align-items-center gap-2"><span class="badge bg-${badgeClass} text-uppercase">${formatInteractionType(tipo)}</span><small class="text-muted">${dataHora}${owner}</small></div>`;
            const corpo = buildTimelineBody(evento);
            return `<li class="mb-3 pb-3 border-bottom">${header}${corpo}</li>`;
        }).join('');

        container.innerHTML = itemsHtml;
    }

    function buildTimelineBody(evento) {
        const tipo = evento.interaction_type;
        const metadata = evento.metadata || {};
        const notes = evento.notes ? `<p class="mb-2">${escapeHtml(evento.notes)}</p>` : '';

        if (tipo === 'status_change') {
            const fromLabel = metadata?.from?.label || metadata?.from?.value || '‚Äî';
            const toLabel = metadata?.to?.label || metadata?.to?.value || '‚Äî';
            return `
                <div class="mt-2">
                    <i class="bi bi-arrow-right-circle"></i>
                    <strong>${escapeHtml(fromLabel)}</strong>
                    <span class="mx-1">‚Üí</span>
                    <strong>${escapeHtml(toLabel)}</strong>
                </div>
            `;
        }

        if (tipo === 'update') {
            const changes = Array.isArray(metadata.changes) ? metadata.changes : [];
            if (changes.length === 0) {
                return notes || '<p class="mb-0 text-muted">Dados atualizados.</p>';
            }
            const itens = changes.map(change => {
                const fieldLabel = formatFieldLabel(change.field);
                const oldVal = formatValue(change.old);
                const newVal = formatValue(change.new);
                return `<li><strong>${escapeHtml(fieldLabel)}:</strong> <span class="text-muted">${oldVal}</span> <span class="mx-1">‚Üí</span> ${newVal}</li>`;
            }).join('');
            return `<div class="mt-2"><ul class="mb-0 ps-3">${itens}</ul></div>`;
        }

        if (tipo === 'create') {
            const statusLabel = metadata?.status?.label || metadata?.status?.value;
            return `<p class="mb-0">Lead criado${statusLabel ? ` com status <strong>${escapeHtml(statusLabel)}</strong>` : ''}.</p>`;
        }

        return notes || '<p class="mb-0">Coment√°rio registrado.</p>';
    }

    function formatInteractionType(tipo) {
        switch (tipo) {
            case 'comment':
                return 'Coment√°rio';
            case 'status_change':
                return 'Status';
            case 'update':
                return 'Atualiza√ß√£o';
            case 'create':
                return 'Cria√ß√£o';
            default:
                return tipo;
        }
    }

    function formatFieldLabel(field) {
        return FIELD_LABELS[field] || field;
    }

    function formatValue(value) {
        if (value === null || value === undefined) {
            return '<span class="text-muted">‚Äî</span>';
        }
        const trimmed = String(value).trim();
        return trimmed ? escapeHtml(trimmed) : '<span class="text-muted">‚Äî</span>';
    }

    function formatDateTime(isoString) {
        if (!isoString) {
            return 'Data n√£o informada';
        }
        const date = new Date(isoString);
        if (Number.isNaN(date.getTime())) {
            return escapeHtml(isoString);
        }
        return date.toLocaleString('pt-BR', { dateStyle: 'short', timeStyle: 'short' });
    }

    function escapeHtml(text) {
        if (text === null || text === undefined) {
            return '';
        }
        return String(text)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#039;');
    }

    function novoLead() {
        const lead = {
            id: null,
            name: '',
            category: '',
            customer_type: 'B2B',
            phone: '',
            whatsapp: '',
            instagram: '',
            email: '',
            website: '',
            status: DEFAULT_STAGE,
            city: '',
            state: '',
            country: '',
            notes: '',
            primary_contact_name: '',
            source: '',
            user_id: CURRENT_USER_ID
        };
        renderLeadModal(lead);
    }

    async function editarLead(leadId) {
        try {
            const response = await fetch(`/crm/api/leads?lead_id=${leadId}`);
            const data = await response.json();
            if (!data.success || !data.leads || data.leads.length === 0) {
                throw new Error('Lead n√£o encontrado');
            }
            renderLeadModal(data.leads[0]);

        } catch (error) {
            mostrarToast(`Erro: ${error.message}`, 'danger');
        }
    }

    function renderLeadModal(lead) {
        const isNew = !lead || !lead.id;
        const safe = (v) => (v ?? '');
        const title = isNew ? 'Novo Lead' : `Editar Lead: ${escapeHtml(lead.name || '')}`;
        const modalHtml = `
            <div class="modal fade" id="modalEditarLead" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">${title}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="formEditarLead" class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Nome</label>
                                    <input type="text" class="form-control" name="name" value="${safe(lead.name)}" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Categoria</label>
                                    <input type="text" class="form-control" name="category" value="${safe(lead.category)}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Telefone</label>
                                    <input type="text" class="form-control" name="phone" value="${safe(lead.phone)}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">WhatsApp</label>
                                    <input type="text" class="form-control" name="whatsapp" value="${safe(lead.whatsapp)}" placeholder="Ex: 11999999999">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Instagram</label>
                                    <input type="text" class="form-control" name="instagram" value="${safe(lead.instagram)}" placeholder="Ex: usuario">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">E-mail</label>
                                    <input type="email" class="form-control" name="email" value="${safe(lead.email)}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Website</label>
                                    <input type="url" class="form-control" name="website" value="${safe(lead.website)}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Contato principal</label>
                                    <input type="text" class="form-control" name="primary_contact_name" value="${safe(lead.primary_contact_name)}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Origem</label>
                                    <input type="text" class="form-control" name="source" value="${safe(lead.source)}" placeholder="Google Maps, Indica√ß√£o...">
                                </div>
                                ${renderUserField(lead.user_id)}
                                <div class="col-md-4">
                                    <label class="form-label">Tipo de Cliente</label>
                                    <select class="form-select" name="customer_type">
                                        <option value="B2B" ${safe(lead.customer_type) === 'B2C' ? '' : 'selected'}>B2B - Revenda/Atacado</option>
                                        <option value="B2C" ${safe(lead.customer_type) === 'B2C' ? 'selected' : ''}>B2C - Consumidor Final</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Status</label>
                                    ${renderStageSelect({ selected: safe(lead.status) || DEFAULT_STAGE })}
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Cidade</label>
                                    <input type="text" class="form-control" name="city" value="${safe(lead.city)}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Estado</label>
                                    <input type="text" class="form-control" name="state" value="${safe(lead.state)}" maxlength="2">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Pa√≠s</label>
                                    <select class="form-select" name="country">
                                        ${buildCountryOptions(safe(lead.country), true)}
                                    </select>
                                </div>
                                <div class="col-md-12">
                                    <label class="form-label">Observa√ß√µes</label>
                                    <textarea class="form-control" name="notes" rows="2">${safe(lead.notes)}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="salvarLeadModal(${lead.id ? lead.id : 'null'})">Salvar</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        const oldModal = document.getElementById('modalEditarLead');
        if (oldModal) oldModal.remove();
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        const modal = new bootstrap.Modal(document.getElementById('modalEditarLead'));
        modal.show();
    }

    async function salvarLeadModal(leadId) {
        try {
            const form = document.getElementById('formEditarLead');
            const formData = new FormData(form);
            const payload = Object.fromEntries(formData.entries());

            let response;
            if (leadId) {
                response = await fetch(`/crm/api/leads/${leadId}`, {
                    method: 'PATCH',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
            } else {
                response = await fetch('/crm/api/leads', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
            }

            const result = await response.json();
            if (!result.success) throw new Error(result.error || 'Erro ao atualizar lead');

            mostrarToast(leadId ? 'Lead atualizado com sucesso!' : 'Lead criado com sucesso!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalEditarLead')).hide();
            carregarLeads();
        } catch (error) {
            mostrarToast(`Erro: ${error.message}`, 'danger');
        }
    }

    function mostrarToast(message, variant = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${variant} border-0`;
        toast.role = 'alert';
        toast.innerHTML = `
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        `;

        const container = document.createElement('div');
        container.className = 'toast-container position-fixed top-0 end-0 p-3';
        container.appendChild(toast);
        document.body.appendChild(container);

        const bsToast = new bootstrap.Toast(toast, { delay: 4000 });
        bsToast.show();

        toast.addEventListener('hidden.bs.toast', () => container.remove());
    }
</script>
{% endblock %}
