{% extends "base.html" %}

{% block title %}Dashboard Local - Consciência Café{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="bi bi-speedometer2"></i> Dashboard Financeiro
        <span class="badge bg-success ms-2">LOCAL</span>
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="/local/extrato-pj" class="btn btn-primary me-2">
            <i class="bi bi-table"></i> Ver Extratos
        </a>
        <button type="button" class="btn btn-outline-secondary" onclick="alert('Painel administrativo em desenvolvimento');">
            <i class="bi bi-gear"></i> Admin
        </button>
    </div>
</div>

<!-- Alerta de Status -->
{% if error %}
<div class="alert alert-danger">
    <i class="bi bi-exclamation-triangle"></i> {{ error }}
</div>
{% endif %}

<!-- Informações de Fonte de Dados -->
<div class="alert alert-info">
    <i class="bi bi-database"></i>
    <strong>Dados Locais:</strong> Sistema usando banco SQLite local.
    {% if migration_info.status %}
        Última migração: {{ migration_info.status }} em {{ migration_info.date if migration_info.date else 'N/A' }}
    {% endif %}
</div>

<!-- Cards de Estatísticas Principais -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_accounts or 0 }}</h4>
                        <p class="card-text">Contas Ativas</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-bank display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ "{:,}".format(stats.total_transactions or 0) }}</h4>
                        <p class="card-text">Transações</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-arrow-left-right display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_clients or 0 }}</h4>
                        <p class="card-text">Clientes/Fornecedores</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-people display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 class="card-title">{{ stats.total_categories or 0 }}</h4>
                        <p class="card-text">Categorias</p>
                    </div>
                    <div class="align-self-center">
                        <i class="bi bi-tags display-4"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Período dos Dados -->
{% if stats.date_range and stats.date_range.start %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-calendar-range"></i> Período dos Dados
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <strong>Data Inicial:</strong> {{ stats.date_range.start }}
                    </div>
                    <div class="col-md-6">
                        <strong>Data Final:</strong> {{ stats.date_range.end }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Contas Disponíveis -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-bank"></i> Contas Disponíveis
                </h5>
            </div>
            <div class="card-body">
                {% if accounts %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Nome</th>
                                <th>Tipo</th>
                                <th>Banco</th>
                                <th>Status</th>
                                <th>Saldo</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for account in accounts %}
                            <tr class="{% if not account.get('ativo', True) %}table-secondary{% endif %}">
                                <td><code>{{ account.id }}</code></td>
                                <td>
                                    {{ account.nome }}
                                    {% if not account.get('ativo', True) %}
                                        <small class="text-muted d-block">(Conta Inativa)</small>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if account.tipo == 'checking' %}
                                        <span class="badge bg-primary">{{ account.tipo }}</span>
                                    {% elif account.tipo == 'credit' %}
                                        <span class="badge bg-warning">{{ account.tipo }}</span>
                                    {% elif account.tipo == 'cash' %}
                                        <span class="badge bg-success">{{ account.tipo }}</span>
                                    {% elif account.tipo == 'investment' %}
                                        <span class="badge bg-info">{{ account.tipo }}</span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ account.tipo }}</span>
                                    {% endif %}
                                </td>
                                <td>{{ account.banco or 'N/A' }}</td>
                                <td>
                                    {% if account.get('ativo', True) %}
                                        <span class="badge bg-success">
                                            <i class="bi bi-check-circle"></i> Ativa
                                        </span>
                                    {% else %}
                                        <span class="badge bg-danger">
                                            <i class="bi bi-x-circle"></i> Inativa
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    <span class="fw-bold">R$ {{ "%.2f"|format(account.saldo or 0) }}</span>
                                </td>
                                <td>
                                    {% if account.get('ativo', True) %}
                                        <a href="/local/extrato-pj?conta={{ account.id }}" class="btn btn-sm btn-outline-primary">
                                            <i class="bi bi-eye"></i> Ver Extrato
                                        </a>
                                    {% else %}
                                        <button class="btn btn-sm btn-outline-secondary" disabled title="Conta inativa">
                                            <i class="bi bi-eye-slash"></i> Inativa
                                        </button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h5 class="text-muted mt-3">Nenhuma conta encontrada</h5>
                    <p class="text-muted">Execute a migração para importar dados do Omie</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Status de Conciliação -->
{% if stats.reconciliation_status %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-check2-square"></i> Status de Conciliação
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for status, count in stats.reconciliation_status.items() %}
                    <div class="col-md-4 mb-2">
                        <div class="d-flex justify-content-between">
                            <span class="text-capitalize">{{ status }}:</span>
                            <span class="fw-bold">{{ count }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Informações da Migração -->
{% if migration_info and migration_info.status != 'no_migration_found' %}
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-arrow-down-circle"></i> Última Migração
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <strong>Status:</strong>
                        <span class="badge bg-{{ 'success' if migration_info.status == 'completed' else 'warning' }}">
                            {{ migration_info.status }}
                        </span>
                    </div>
                    <div class="col-md-3">
                        <strong>Data:</strong> {{ migration_info.date if migration_info.date else 'N/A' }}
                    </div>
                    <div class="col-md-3">
                        <strong>Registros:</strong> {{ migration_info.successful_records or 0 }}/{{ migration_info.total_records or 0 }}
                    </div>
                    <div class="col-md-3">
                        <strong>Fonte:</strong> {{ migration_info.source or 'N/A' }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Status da Migração em Tempo Real -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="bi bi-activity"></i> Status da Migração
                </h5>
            </div>
            <div class="card-body">
                <div id="migrationStatus">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm me-2"></div>
                        Verificando status...
                    </div>
                </div>
                <button class="btn btn-outline-primary btn-sm mt-2" onclick="checkMigrationStatus()">
                    <i class="bi bi-arrow-clockwise"></i> Atualizar Status
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Verificar status da migração automaticamente
function checkMigrationStatus() {
    fetch('/api/local/status-migracao')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('migrationStatus');

            if (data.success) {
                const status = data.status;
                let html = '';

                if (status.migration_running) {
                    html += `
                        <div class="alert alert-info">
                            <i class="bi bi-arrow-clockwise spinner-border spinner-border-sm me-2"></i>
                            <strong>Migração em execução</strong> (PID: ${status.pid})
                        </div>
                    `;

                    if (status.last_status && status.last_status.progress) {
                        const progress = status.last_status.progress;
                        html += `
                            <div class="mb-2">
                                <strong>Progresso:</strong> ${progress.current_account || 0}/${progress.total_accounts || 0} contas
                            </div>
                            <div class="progress mb-2">
                                <div class="progress-bar" style="width: ${(progress.current_account || 0) / (progress.total_accounts || 1) * 100}%"></div>
                            </div>
                        `;

                        if (progress.current_account_name) {
                            html += `<small class="text-muted">Processando: ${progress.current_account_name}</small>`;
                        }
                    }
                } else {
                    html += `
                        <div class="alert alert-secondary">
                            <i class="bi bi-pause-circle me-2"></i>
                            <strong>Nenhuma migração em execução</strong>
                        </div>
                    `;
                }

                statusDiv.innerHTML = html;
            } else {
                statusDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        Erro ao verificar status: ${data.error}
                    </div>
                `;
            }
        })
        .catch(error => {
            document.getElementById('migrationStatus').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    Erro de conexão: ${error.message}
                </div>
            `;
        });
}

// Verificar status ao carregar a página e a cada 30 segundos
document.addEventListener('DOMContentLoaded', function() {
    checkMigrationStatus();
    setInterval(checkMigrationStatus, 30000);
});
</script>

{% endblock %}
